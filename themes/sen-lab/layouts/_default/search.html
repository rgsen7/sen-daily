{{ define "main" }}
<div class="mb-6">
  <h1 class="text-2xl font-extrabold" style="color: var(--fg);">搜索</h1>
</div>
<div class="relative mb-8">
  <input id="searchInput" type="text" placeholder="输入关键词或 /正则/ ..."
         class="w-full text-sm font-mono px-4 py-3 rounded-lg outline-none transition-shadow"
         style="background: var(--entry); border: 1px solid var(--border); color: var(--fg);"
         onfocus="this.style.borderColor='var(--fg-secondary)'" onblur="this.style.borderColor='var(--border)'">
  <kbd class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono px-1.5 py-0.5 rounded" style="color: var(--fg-secondary); opacity: 0.4; background: var(--code-bg);">/</kbd>
</div>
<div id="searchResults"></div>
<div id="searchEmpty" class="hidden py-8 text-center">
  <p class="text-sm font-mono" style="color: var(--fg-secondary);">无结果</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<script>
  let fuse;
  const input = document.getElementById('searchInput');
  const resultsEl = document.getElementById('searchResults');
  const emptyEl = document.getElementById('searchEmpty');

  fetch('{{ .Site.BaseURL }}index.json')
    .then(r => r.json())
    .then(data => {
      fuse = new Fuse(data, {
        keys: ['title', 'content', 'summary'],
        threshold: 0.3,
        distance: 1000,
        includeMatches: true,
        minMatchCharLength: 2
      });
    });

  document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement !== input) {
      e.preventDefault();
      input.focus();
    }
    if (e.key === 'Escape') input.blur();
  });

  input.addEventListener('input', function() {
    const q = this.value.trim();
    if (!q || !fuse) { resultsEl.innerHTML = ''; emptyEl.classList.add('hidden'); return; }

    let searchResults;
    const regexMatch = q.match(/^\/(.+)\/([gimsuy]*)$/);
    if (regexMatch) {
      try {
        const re = new RegExp(regexMatch[1], regexMatch[2] || 'i');
        searchResults = fuse._docs
          .filter(d => re.test(d.title) || re.test(d.content))
          .map(d => ({ item: d }));
      } catch(e) { searchResults = []; }
    } else {
      searchResults = fuse.search(q);
    }

    if (searchResults.length === 0) {
      resultsEl.innerHTML = '';
      emptyEl.classList.remove('hidden');
      return;
    }

    emptyEl.classList.add('hidden');
    resultsEl.innerHTML = searchResults.slice(0, 20).map(r => {
      const d = r.item;
      return `<a href="${d.permalink}" class="post-entry block" style="text-decoration: none;">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0 flex-1">
            <h3 class="text-base font-bold" style="color: var(--fg);">${d.title}</h3>
            ${d.summary ? `<p class="text-sm mt-1 line-clamp-2" style="color: var(--fg-secondary);">${d.summary}</p>` : ''}
          </div>
          <time class="text-xs font-mono shrink-0" style="color: var(--fg-secondary);">${d.date || ''}</time>
        </div>
      </a>`;
    }).join('');
  });
</script>
{{ end }}
