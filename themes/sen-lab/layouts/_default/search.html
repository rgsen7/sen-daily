{{ define "main" }}
<div>
  <h1 class="text-lg font-semibold dark:text-fg text-fg-light tracking-tight mb-4">搜索</h1>
  <div class="relative mb-6">
    <input id="searchInput" type="text" placeholder="输入关键词或 /正则/ ..." 
           class="w-full dark:bg-white/[0.04] bg-gray-50 border dark:border-border border-gray-200 rounded-md px-4 py-2.5 text-sm dark:text-fg text-fg-light font-mono placeholder:dark:text-fg-muted/40 placeholder:text-gray-300 focus:outline-none focus:ring-1 focus:ring-accent/50 transition-shadow">
    <kbd class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono dark:text-fg-muted/40 text-gray-300 dark:bg-white/[0.04] bg-gray-100 px-1.5 py-0.5 rounded">/</kbd>
  </div>
  <div id="searchResults" class="space-y-1"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<script>
  let fuse;
  const input = document.getElementById('searchInput');
  const results = document.getElementById('searchResults');

  // Load index
  fetch('{{ .Site.BaseURL }}index.json')
    .then(r => r.json())
    .then(data => {
      fuse = new Fuse(data, {
        keys: ['title', 'content', 'summary'],
        threshold: 0.3,
        distance: 1000,
        includeMatches: true,
        minMatchCharLength: 2
      });
    });

  // Keyboard shortcut
  document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement !== input) {
      e.preventDefault();
      input.focus();
    }
    if (e.key === 'Escape') input.blur();
  });

  input.addEventListener('input', function() {
    const q = this.value.trim();
    if (!q || !fuse) { results.innerHTML = ''; return; }

    // Check for regex pattern
    let searchResults;
    const regexMatch = q.match(/^\/(.+)\/([gimsuy]*)$/);
    if (regexMatch) {
      try {
        const re = new RegExp(regexMatch[1], regexMatch[2] || 'i');
        searchResults = fuse._docs
          .filter(d => re.test(d.title) || re.test(d.content))
          .map(d => ({ item: d }));
      } catch(e) { searchResults = []; }
    } else {
      searchResults = fuse.search(q);
    }

    results.innerHTML = searchResults.slice(0, 20).map(r => {
      const d = r.item;
      return `<a href="${d.permalink}" class="group flex items-baseline gap-4 py-3 border-b dark:border-border border-gray-100 hover:dark:bg-white/[0.02] hover:bg-gray-50 -mx-3 px-3 rounded transition-colors">
        <time class="text-xs font-mono dark:text-fg-muted text-gray-400 shrink-0">${d.date || ''}</time>
        <div class="min-w-0">
          <h3 class="text-sm font-medium dark:text-fg text-fg-light group-hover:text-accent transition-colors truncate">${d.title}</h3>
          ${d.summary ? `<p class="text-xs dark:text-fg-muted text-gray-500 mt-1 line-clamp-1">${d.summary}</p>` : ''}
        </div>
      </a>`;
    }).join('');

    if (searchResults.length === 0) {
      results.innerHTML = '<p class="text-xs dark:text-fg-muted text-gray-400 py-4 font-mono">无结果</p>';
    }
  });
</script>
{{ end }}
